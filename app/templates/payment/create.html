<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Thanh Toán - HotelBooking</title>
    
    <!-- Bootstrap 5 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    
    <!-- Bootstrap Icons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    
    <!-- Custom CSS -->
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
</head>
<body>

    <!-- HEADER / NAVIGATION -->
    <nav class="navbar navbar-expand-lg">
        <div class="container">
            <a class="navbar-brand" href="{{ url_for('main.index') }}">
                <i class="bi bi-building"></i> HotelBooking
            </a>
            
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav mx-auto">
                    <li class="nav-item">
                        <a class="nav-link" href="{{ url_for('main.index') }}">Trang chủ</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="{{ url_for('booking.list_bookings') }}">Đặt phòng của tôi</a>
                    </li>
                </ul>
                
                {% if session.get('user_id') %}
                <div class="d-flex gap-2 ms-3">
                    <a href="{{ url_for('user.profile') }}" class="btn btn-outline-primary">Tài khoản</a>
                </div>
                {% else %}
                <div class="d-flex gap-2 ms-3">
                    <a href="{{ url_for('auth.login') }}" class="btn btn-outline-primary">Đăng nhập</a>
                </div>
                {% endif %}
            </div>
        </div>
    </nav>

    <!-- PAYMENT SECTION -->
    <section class="payment-section py-5">
        <div class="container">
            <div class="row">
                <div class="col-lg-8 mx-auto">
                    <!-- Page Title -->
                    <div class="text-center mb-5">
                        <h1 class="display-5 fw-bold mb-3">
                            <i class="bi bi-credit-card text-primary"></i>
                            Thanh toán
                        </h1>
                        <p class="text-secondary">Hoàn tất thanh toán để xác nhận đặt phòng của bạn</p>
                    </div>

                    <!-- Payment Processing Status -->
                    <div id="paymentStatus" class="payment-status-card" style="display: none;">
                        <div class="text-center py-5">
                            <div class="payment-loading mb-4">
                                <div class="spinner-border text-primary" role="status" style="width: 4rem; height: 4rem;">
                                    <span class="visually-hidden">Đang xử lý...</span>
                                </div>
                            </div>
                            <h3 class="mb-3">Đang xử lý thanh toán...</h3>
                            <p class="text-secondary">Vui lòng không đóng trang này</p>
                        </div>
                    </div>

                    <!-- Success Message -->
                    <div id="paymentSuccess" class="payment-result-card success-card" style="display: none;">
                        <div class="text-center py-5">
                            <div class="result-icon success-icon mb-4">
                                <i class="bi bi-check-circle-fill"></i>
                            </div>
                            <h2 class="mb-3">Thanh toán thành công!</h2>
                            <p class="text-secondary mb-4">Đơn đặt phòng của bạn đã được xác nhận</p>
                            <div class="d-flex gap-3 justify-content-center">
                                <a href="#" class="btn btn-primary btn-lg">
                                    <i class="bi bi-file-text me-2"></i>
                                    Xem chi tiết đơn hàng
                                </a>
                                <a href="{{ url_for('main.index') }}" class="btn btn-outline-primary btn-lg">
                                    <i class="bi bi-house me-2"></i>
                                    Về trang chủ
                                </a>
                            </div>
                        </div>
                    </div>

                    <!-- Error Message -->
                    <div id="paymentError" class="payment-result-card error-card" style="display: none;">
                        <div class="text-center py-5">
                            <div class="result-icon error-icon mb-4">
                                <i class="bi bi-x-circle-fill"></i>
                            </div>
                            <h2 class="mb-3">Thanh toán thất bại</h2>
                            <p class="text-secondary mb-4" id="errorMessage">Đã có lỗi xảy ra trong quá trình thanh toán</p>
                            <div class="d-flex gap-3 justify-content-center">
                                <button class="btn btn-danger btn-lg" onclick="retryPayment()">
                                    <i class="bi bi-arrow-repeat me-2"></i>
                                    Thử lại
                                </button>
                                <a href="{{ url_for('booking.list_bookings') }}" class="btn btn-outline-secondary btn-lg">
                                    <i class="bi bi-list me-2"></i>
                                    Xem đơn đặt phòng
                                </a>
                            </div>
                        </div>
                    </div>

                    <!-- Payment Form -->
                    <div id="paymentForm">
                        <div class="row g-4">
                            <!-- Left Column: Order Info & Payment Method -->
                            <div class="col-lg-7">
                                <!-- Order Information -->
                                <div class="content-card mb-4">
                                    <h4 class="content-title mb-4">
                                        <i class="bi bi-info-circle me-2"></i>
                                        Thông tin đơn hàng
                                    </h4>
                                    
                                    <form method="POST" action="{{ url_for('payment.create_payment') }}" id="paymentFormElement">
                                        <div class="mb-4">
                                            <label class="form-label fw-bold">Mã đặt phòng</label>
                                            <div class="booking-code-display">
                                                <input type="number" class="form-control form-control-lg" name="booking_id" 
                                                       placeholder="Nhập mã đặt phòng..." required id="bookingIdInput">
                                            </div>
                                        </div>

                                        <!-- Booking Details (Dynamic) -->
                                        <div id="bookingDetails" class="booking-details-section" style="display: none;">
                                            <div class="booking-info-card mb-4">
                                                <div class="row mb-3">
                                                    <div class="col-5 text-secondary">Khách sạn:</div>
                                                    <div class="col-7 fw-bold" id="hotelName">-</div>
                                                </div>
                                                <div class="row mb-3">
                                                    <div class="col-5 text-secondary">Loại phòng:</div>
                                                    <div class="col-7 fw-bold" id="roomType">-</div>
                                                </div>
                                                <div class="row mb-3">
                                                    <div class="col-5 text-secondary">Ngày nhận - trả:</div>
                                                    <div class="col-7 fw-bold" id="bookingDates">-</div>
                                                </div>
                                                <div class="row">
                                                    <div class="col-5 text-secondary">Số khách:</div>
                                                    <div class="col-7 fw-bold" id="numGuests">-</div>
                                                </div>
                                            </div>
                                        </div>

                                        <!-- Payment Method Selection -->
                                        <div class="payment-method-section mt-4">
                                            <h4 class="content-title mb-4">
                                                <i class="bi bi-wallet2 me-2"></i>
                                                Chọn phương thức thanh toán
                                            </h4>

                                            <div class="payment-methods">
                                                <!-- PayPal -->
                                                <div class="payment-method-card">
                                                    <input type="radio" class="payment-method-radio" name="payment_method" 
                                                           id="paypal" value="paypal" checked>
                                                    <label class="payment-method-label" for="paypal">
                                                        <div class="d-flex align-items-center">
                                                            <div class="payment-icon" style="background: #0070ba; color: white;">
                                                                <i class="bi bi-wallet2"></i>
                                                            </div>
                                                            <div class="flex-grow-1">
                                                                <h5 class="mb-1">PayPal</h5>
                                                                <p class="mb-0 small text-secondary">
                                                                    Thanh toán quốc tế qua PayPal
                                                                </p>
                                                            </div>
                                                            <div class="payment-check">
                                                                <i class="bi bi-check-circle-fill"></i>
                                                            </div>
                                                        </div>
                                                    </label>
                                                </div>

                                                <!-- Pay at Hotel -->
                                                <div class="payment-method-card">
                                                    <input type="radio" class="payment-method-radio" name="payment_method" 
                                                           id="cash" value="cash">
                                                    <label class="payment-method-label" for="cash">
                                                        <div class="d-flex align-items-center">
                                                            <div class="payment-icon cash-icon">
                                                                <i class="bi bi-cash-stack"></i>
                                                            </div>
                                                            <div class="flex-grow-1">
                                                                <h5 class="mb-1">Thanh toán tại khách sạn</h5>
                                                                <p class="mb-0 small text-secondary">
                                                                    Thanh toán bằng tiền mặt hoặc thẻ khi nhận phòng
                                                                </p>
                                                            </div>
                                                            <div class="payment-check">
                                                                <i class="bi bi-check-circle-fill"></i>
                                                            </div>
                                                        </div>
                                                    </label>
                                                </div>
                                            </div>
                                        </div>

                                        <!-- Payment Note -->
                                        <div class="alert alert-info mt-4">
                                            <i class="bi bi-shield-check me-2"></i>
                                            <strong>Thanh toán an toàn:</strong> Thông tin của bạn được mã hóa và bảo mật tuyệt đối
                                        </div>
                                    </form>
                                </div>
                            </div>

                            <!-- Right Column: Price Summary -->
                            <div class="col-lg-5">
                                <div class="payment-summary-card sticky-summary">
                                    <h4 class="mb-4 pb-3 border-bottom">
                                        <i class="bi bi-receipt me-2"></i>
                                        Tóm tắt thanh toán
                                    </h4>

                                    <!-- Price Breakdown -->
                                    <div class="price-breakdown mb-4">
                                        <div class="price-row">
                                            <span class="text-secondary">Giá phòng</span>
                                            <span class="fw-bold" id="roomPrice">0₫</span>
                                        </div>
                                        <div class="price-row">
                                            <span class="text-secondary">Thuế & phí dịch vụ</span>
                                            <span class="fw-bold" id="serviceFee">0₫</span>
                                        </div>
                                        <div class="price-row">
                                            <span class="text-secondary">Giảm giá</span>
                                            <span class="fw-bold text-success" id="discount">-0₫</span>
                                        </div>
                                    </div>

                                    <!-- Total Amount -->
                                    <div class="total-amount-section">
                                        <div class="d-flex justify-content-between align-items-center mb-4">
                                            <span class="fs-5 fw-bold">Tổng cộng</span>
                                            <span class="fs-3 fw-bold text-primary" id="totalAmount">0₫</span>
                                        </div>
                                    </div>

                                    <!-- Payment Button -->
                                    <button type="submit" form="paymentFormElement" class="btn btn-success btn-lg w-100 mb-3">
                                        <i class="bi bi-lock-fill me-2"></i>
                                        Xác nhận thanh toán
                                    </button>

                                    <!-- Back to Booking -->
                                    <a href="{{ url_for('booking.list_bookings') }}" class="btn btn-outline-secondary w-100">
                                        <i class="bi bi-arrow-left me-2"></i>
                                        Quay lại đơn đặt phòng
                                    </a>

                                    <!-- Security Note -->
                                    <div class="security-note mt-4">
                                        <div class="d-flex align-items-start">
                                            <i class="bi bi-shield-fill-check text-success me-2 mt-1"></i>
                                            <small class="text-secondary">
                                                Giao dịch được bảo mật bởi mã hóa SSL 256-bit
                                            </small>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- FOOTER -->
    <footer>
        <div class="container">
            <div class="footer-bottom">
                <p>&copy; 2025 HotelBooking. Tất cả các quyền được bảo lưu.</p>
            </div>
        </div>
    </footer>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    
    <!-- Custom JS -->
    <script>
        // Show loading state on form submit
        document.getElementById('paymentFormElement').addEventListener('submit', function(e) {
            e.preventDefault();
            
            // Hide form
            document.getElementById('paymentForm').style.display = 'none';
            
            // Show loading
            document.getElementById('paymentStatus').style.display = 'block';
            
            // Simulate payment processing (in real scenario, this would be an API call)
            setTimeout(function() {
                // Hide loading
                document.getElementById('paymentStatus').style.display = 'none';
                
                // Show success (or error based on payment result)
                // For demo, randomly show success or error
                if (Math.random() > 0.2) {
                    document.getElementById('paymentSuccess').style.display = 'block';
                } else {
                    document.getElementById('paymentError').style.display = 'block';
                    document.getElementById('errorMessage').textContent = 'Không thể kết nối với cổng thanh toán. Vui lòng thử lại.';
                }
            }, 3000);
            
            // In real scenario, submit the form:
            // this.submit();
        });

        // Retry payment
        function retryPayment() {
            document.getElementById('paymentError').style.display = 'none';
            document.getElementById('paymentForm').style.display = 'block';
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        // Load booking details when booking ID is entered
        document.getElementById('bookingIdInput').addEventListener('blur', function() {
            const bookingId = this.value;
            if (bookingId) {
                // In real scenario, fetch booking details via API
                // For demo, show sample data
                document.getElementById('bookingDetails').style.display = 'block';
                document.getElementById('hotelName').textContent = 'Khách sạn Mẫu';
                document.getElementById('roomType').textContent = 'Phòng Deluxe';
                document.getElementById('bookingDates').textContent = '15/01/2025 - 17/01/2025';
                document.getElementById('numGuests').textContent = '2 người';
                
                // Update price
                document.getElementById('roomPrice').textContent = '2.000.000₫';
                document.getElementById('serviceFee').textContent = '200.000₫';
                document.getElementById('discount').textContent = '-200.000₫';
                document.getElementById('totalAmount').textContent = '2.000.000₫';
            }
        });

        // Payment method selection animation
        document.querySelectorAll('.payment-method-radio').forEach(radio => {
            radio.addEventListener('change', function() {
                document.querySelectorAll('.payment-method-card').forEach(card => {
                    card.classList.remove('selected');
                });
                this.closest('.payment-method-card').classList.add('selected');
            });
        });

        // Set initial selected state
        document.querySelector('.payment-method-radio:checked').closest('.payment-method-card').classList.add('selected');
    </script>
</body>
</html>
