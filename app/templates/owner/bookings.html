{% extends "owner/base.html" %}

{% block title %}Quản lý Đặt phòng{% endblock %}

{% block content %}

<div class="owner-header">
    <div>
        <h1 class="owner-header-title">
            <i class="fas fa-calendar-check me-2"></i> Quản lý Đặt phòng
        </h1>
        <p class="owner-header-subtitle">Xem và quản lý tất cả booking của khách sạn</p>
    </div>
    <div class="owner-header-actions">
        <a href="{{ url_for('owner.dashboard') }}" class="owner-btn owner-btn-outline">
            <i class="fas fa-arrow-left"></i> Quay lại
        </a>
    </div>
</div>

<!-- Filter Bar -->
<div class="owner-filter-bar">
    <form method="GET" action="{{ url_for('owner.owner_bookings') }}">
        <div class="owner-filter-row">
            <div class="owner-filter-group">
                <label for="status">
                    <i class="fas fa-filter me-1"></i> Lọc theo trạng thái
                </label>
                <select name="status" id="status" class="form-select">
                    <option value="">-- Tất cả trạng thái --</option>
                    <option value="pending" {% if request.args.get('status') == 'pending' %}selected{% endif %}>Chờ xác nhận</option>
                    <option value="confirmed" {% if request.args.get('status') == 'confirmed' %}selected{% endif %}>Đã xác nhận</option>
                    <option value="checked_in" {% if request.args.get('status') == 'checked_in' %}selected{% endif %}>Đã check-in</option>
                    <option value="checked_out" {% if request.args.get('status') == 'checked_out' %}selected{% endif %}>Đã check-out</option>
                    <option value="cancelled" {% if request.args.get('status') == 'cancelled' %}selected{% endif %}>Đã hủy</option>
                </select>
            </div>
            <div class="owner-filter-group" style="flex: 0;">
                <button type="submit" class="owner-btn owner-btn-primary">
                    <i class="fas fa-search"></i> Lọc
                </button>
            </div>
            <div class="owner-filter-group" style="flex: 0;">
                <a href="{{ url_for('owner.owner_bookings') }}" class="owner-btn owner-btn-secondary">
                    <i class="fas fa-redo"></i> Xóa lọc
                </a>
            </div>
        </div>
    </form>
</div>

{% set payload = result[0].json if result and result[1] == 200 else None %}
{% set bookings = payload.data.bookings if payload and payload.data and payload.data.bookings else [] %}

<!-- Bookings Table -->
<div class="owner-table-wrapper">
    <div class="owner-table-header">
        <h3 class="owner-table-title">
            <i class="fas fa-list me-2"></i> Danh sách đặt phòng
        </h3>
        <span class="badge bg-primary" style="font-size: 1rem; padding: 0.5rem 1rem;">
            <i class="fas fa-ticket-alt me-1"></i> Tổng: {{ bookings|length }} booking
        </span>
    </div>
    {% if bookings %}
        <div class="table-responsive">
            <table class="owner-table">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Khách sạn</th>
                        <th>Khách hàng</th>
                        <th>Check-in</th>
                        <th>Check-out</th>
                        <th class="text-center">Trạng thái</th>
                        <th class="text-end">Số tiền</th>
                        <th class="text-center">Thao tác</th>
                    </tr>
                </thead>
                <tbody>
                    {% for booking in bookings %}
                    <tr>
                        <td><strong>#{{ booking.booking_id }}</strong></td>
                        <td>
                            <div class="d-flex align-items-center">
                                <i class="fas fa-hotel text-primary me-2"></i>
                                <div>
                                    <strong>{{ booking.hotel.hotel_name if booking.hotel else 'N/A' }}</strong>
                                    <div class="text-muted small">ID: {{ booking.hotel_id }}</div>
                                </div>
                            </div>
                        </td>
                        <td>
                            <div class="d-flex align-items-center">
                                <i class="fas fa-user-circle text-info me-2" style="font-size: 1.5rem;"></i>
                                <div>
                                    <strong>{{ booking.user.full_name if booking.user else 'N/A' }}</strong>
                                    <div class="text-muted small">ID: {{ booking.user_id }}</div>
                                </div>
                            </div>
                        </td>
                        <td>
                            <i class="fas fa-sign-in-alt text-success me-1"></i>
                            {{ booking.check_in_date }}
                        </td>
                        <td>
                            <i class="fas fa-sign-out-alt text-danger me-1"></i>
                            {{ booking.check_out_date }}
                        </td>
                        <td class="text-center">
                            <span class="owner-badge status-{{ booking.status }}">
                                {{ booking.status }}
                            </span>
                        </td>
                        <td class="text-end">
                            <strong class="text-success" style="font-size: 1.1rem;">
                                {{ "{:,.0f}".format(booking.final_amount) }} VNĐ
                            </strong>
                        </td>
                        <td class="text-center">
                            <div class="btn-group" role="group">
                                <a href="{{ url_for('owner.owner_booking_detail', booking_id=booking.booking_id) }}" 
                                   class="btn btn-sm btn-info text-white" 
                                   title="Xem chi tiết">
                                    <i class="fas fa-eye"></i>
                                </a>
                                
                                {% if booking.status == 'confirmed' %}
                                <form action="{{ url_for('booking.check_in', booking_id=booking.booking_id) }}" 
                                      method="POST" 
                                      style="display:inline;">
                                    <button type="submit" 
                                            class="btn btn-sm btn-success" 
                                            title="Check-in">
                                        <i class="fas fa-door-open"></i>
                                    </button>
                                </form>
                                {% elif booking.status == 'checked_in' %}
                                <form action="{{ url_for('booking.check_out', booking_id=booking.booking_id) }}" 
                                      method="POST" 
                                      style="display:inline;">
                                    <button type="submit" 
                                            class="btn btn-sm btn-primary" 
                                            title="Check-out">
                                        <i class="fas fa-sign-out-alt"></i>
                                    </button>
                                </form>
                                {% endif %}
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    {% else %}
        <div class="owner-empty-state">
            <div class="owner-empty-icon">
                <i class="fas fa-calendar-times"></i>
            </div>
            <h4 class="owner-empty-title">Không có booking nào</h4>
            <p class="owner-empty-text">
                {% if request.args.get('status') %}
                    Không tìm thấy booking với trạng thái này.
                {% else %}
                    Chưa có booking nào được tạo cho khách sạn của bạn.
                {% endif %}
            </p>
            {% if request.args.get('status') %}
                <a href="{{ url_for('owner.owner_bookings') }}" class="owner-btn owner-btn-primary">
                    <i class="fas fa-redo"></i> Xem tất cả
                </a>
            {% endif %}
        </div>
    {% endif %}
</div>

{% endblock %}
