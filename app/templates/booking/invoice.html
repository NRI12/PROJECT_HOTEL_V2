<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hóa đơn {% if result and result[0].json.data.invoice %}#{{ result[0].json.data.invoice.booking_code }}{% endif %} - HotelBooking</title>
    
    <!-- Bootstrap 5 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    
    <!-- Bootstrap Icons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    
    <!-- Custom CSS -->
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
</head>
<body style="background: #f8f9fa;">

    <!-- Navigation (Hidden when printing) -->
    <nav class="navbar navbar-expand-lg no-print">
        <div class="container">
            <a class="navbar-brand" href="{{ url_for('main.index') }}">
                <i class="bi bi-building"></i> HotelBooking
            </a>
            
            <div class="ms-auto">
                <a href="{{ url_for('booking.booking_detail', booking_id=booking_id) }}" class="btn btn-outline-secondary me-2">
                    <i class="bi bi-arrow-left me-2"></i>Quay lại
                </a>
                <button onclick="window.print()" class="btn btn-primary">
                    <i class="bi bi-printer me-2"></i>In hóa đơn
                </button>
            </div>
        </div>
    </nav>

    {% if result and result[0].json.data.invoice %}
        {% set invoice = result[0].json.data.invoice %}
        
        <div class="invoice-container">
            <!-- Invoice Header -->
            <div class="invoice-header">
                <div class="row align-items-start">
                    <div class="col-md-6">
                        <div class="invoice-logo mb-3">HOTELBOOKING</div>
                        <div class="invoice-meta">
                            <p class="mb-1">123 Đường Lê Lợi, Quận 1</p>
                            <p class="mb-1">TP. Hồ Chí Minh, Việt Nam</p>
                            <p class="mb-1">Điện thoại: +84 123 456 789</p>
                            <p class="mb-0">Email: contact@hotelbooking.vn</p>
                        </div>
                    </div>
                    <div class="col-md-6 text-end">
                        <div class="invoice-title mb-3">HÓA ĐƠN</div>
                        <div class="invoice-meta">
                            <p class="mb-1"><strong>Mã booking:</strong> {{ invoice.booking_code }}</p>
                            <p class="mb-1"><strong>Ngày tạo:</strong> {{ invoice.created_at[:10] if invoice.created_at else 'N/A' }}</p>
                        </div>
                        {% if invoice.payment_status == 'paid' %}
                        <div class="mt-3">
                            <div class="invoice-stamp">ĐÃ THANH TOÁN</div>
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>

            <!-- Customer & Hotel Info -->
            <div class="row mb-4">
                <div class="col-md-6">
                    <div class="invoice-info-box">
                        <h5>THÔNG TIN KHÁCH HÀNG</h5>
                        {% if invoice.customer %}
                        <p><span class="invoice-info-label">Họ tên:</span> {{ invoice.customer.full_name }}</p>
                        <p><span class="invoice-info-label">Email:</span> {{ invoice.customer.email }}</p>
                        <p><span class="invoice-info-label">Điện thoại:</span> {{ invoice.customer.phone or 'N/A' }}</p>
                        {% if invoice.customer.address %}
                        <p><span class="invoice-info-label">Địa chỉ:</span> {{ invoice.customer.address }}</p>
                        {% endif %}
                        {% else %}
                        <p class="text-muted">Không có thông tin</p>
                        {% endif %}
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="invoice-info-box">
                        <h5>THÔNG TIN KHÁCH SẠN</h5>
                        {% if invoice.hotel %}
                        <p><span class="invoice-info-label">Tên:</span> {{ invoice.hotel.hotel_name }}</p>
                        <p><span class="invoice-info-label">Địa chỉ:</span> {{ invoice.hotel.address }}</p>
                        <p><span class="invoice-info-label">Điện thoại:</span> {{ invoice.hotel.phone or 'N/A' }}</p>
                        {% if invoice.hotel.email %}
                        <p><span class="invoice-info-label">Email:</span> {{ invoice.hotel.email }}</p>
                        {% endif %}
                        {% else %}
                        <p class="text-muted">Không có thông tin</p>
                        {% endif %}
                    </div>
                </div>
            </div>

            <!-- Booking Details -->
            <div class="invoice-section">
                <h4 class="invoice-section-title">Chi tiết đặt phòng</h4>
                <div class="invoice-booking-details">
                    <div class="invoice-detail-item">
                        <div class="invoice-detail-label">Ngày nhận phòng</div>
                        <div class="invoice-detail-value">{{ invoice.check_in_date }}</div>
                    </div>
                    <div class="invoice-detail-item">
                        <div class="invoice-detail-label">Ngày trả phòng</div>
                        <div class="invoice-detail-value">{{ invoice.check_out_date }}</div>
                    </div>
                    <div class="invoice-detail-item">
                        <div class="invoice-detail-label">Số khách</div>
                        <div class="invoice-detail-value">{{ invoice.num_guests }} người</div>
                    </div>
                </div>
            </div>

            <!-- Room Details -->
            <div class="invoice-section">
                <h4 class="invoice-section-title">Chi tiết phòng</h4>
                <table class="invoice-table">
                    <thead>
                        <tr>
                            <th>Loại phòng</th>
                            <th class="text-center">Số lượng</th>
                            <th class="text-end">Giá/đêm</th>
                            <th class="text-center">Số đêm</th>
                            <th class="text-end">Thành tiền</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for detail in invoice.details %}
                        <tr>
                            <td><strong>{{ detail.room_name or 'Phòng #' + detail.room_id|string }}</strong></td>
                            <td class="text-center">{{ detail.quantity }}</td>
                            <td class="text-end">{{ "{:,.0f}".format(detail.price_per_night) }}₫</td>
                            <td class="text-center">{{ detail.num_nights }}</td>
                            <td class="text-end"><strong>{{ "{:,.0f}".format(detail.subtotal) }}₫</strong></td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>

            <!-- Payment Summary -->
            <div class="invoice-total">
                <div class="invoice-total-row">
                    <span>Tổng tiền phòng:</span>
                    <strong>{{ "{:,.0f}".format(invoice.total_amount) }}₫</strong>
                </div>
                
                {% if invoice.discount_amount > 0 %}
                <div class="invoice-total-row discount">
                    <span>Giảm giá:</span>
                    <strong>-{{ "{:,.0f}".format(invoice.discount_amount) }}₫</strong>
                </div>
                {% endif %}
                
                <div class="invoice-total-row invoice-total-final">
                    <span>TỔNG THANH TOÁN:</span>
                    <span>{{ "{:,.0f}".format(invoice.final_amount) }}₫</span>
                </div>
            </div>

            <!-- Payment History -->
            {% if invoice.payments and invoice.payments|length > 0 %}
            <div class="invoice-section">
                <h4 class="invoice-section-title">Lịch sử thanh toán</h4>
                <table class="invoice-table">
                    <thead>
                        <tr>
                            <th>Ngày thanh toán</th>
                            <th>Phương thức</th>
                            <th class="text-end">Số tiền</th>
                            <th class="text-center">Trạng thái</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for payment in invoice.payments %}
                        <tr>
                            <td>{{ payment.payment_date[:10] if payment.payment_date else 'N/A' }}</td>
                            <td>
                                {% if payment.payment_method == 'vnpay' %}VNPay
                                {% elif payment.payment_method == 'hotel' %}Thanh toán tại khách sạn
                                {% else %}{{ payment.payment_method }}
                                {% endif %}
                            </td>
                            <td class="text-end"><strong>{{ "{:,.0f}".format(payment.amount) }}₫</strong></td>
                            <td class="text-center">
                                <strong>
                                {% if payment.payment_status == 'paid' %}Thành công
                                {% elif payment.payment_status == 'unpaid' %}Chưa thanh toán
                                {% elif payment.payment_status == 'pending' %}Đang xử lý
                                {% else %}{{ payment.payment_status }}
                                {% endif %}
                                </strong>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            {% endif %}

            <!-- Footer -->
            <div class="invoice-footer">
                <div class="row">
                    <div class="col-md-6 invoice-footer-section">
                        <h6 class="invoice-footer-title">CHÍNH SÁCH HỦY PHÒNG</h6>
                        <p class="invoice-footer-text">
                            - Hủy phòng trước 24 giờ: hoàn tiền 100%<br>
                            - Hủy phòng trong vòng 24 giờ: hoàn tiền 50%<br>
                            - Không đến nhận phòng: không hoàn tiền
                        </p>
                    </div>
                    <div class="col-md-6 invoice-footer-section">
                        <h6 class="invoice-footer-title">HỖ TRỢ KHÁCH HÀNG</h6>
                        <p class="invoice-footer-text">
                            Hotline: +84 123 456 789<br>
                            Email: support@hotelbooking.vn<br>
                            Giờ làm việc: 24/7
                        </p>
                    </div>
                </div>
                
                <div class="invoice-footer-note">
                    <p class="mb-1">Cảm ơn quý khách đã sử dụng dịch vụ của HotelBooking!</p>
                    <p class="mb-0">Hóa đơn này được tạo tự động và có giá trị không cần chữ ký.</p>
                </div>
            </div>
        </div>

    {% else %}
        <div class="container my-5">
            <div class="info-card text-center py-5">
                <h1 style="font-size: 4rem; color: #dc3545;">404</h1>
                <h2 class="mt-3">Không tìm thấy hóa đơn</h2>
                <p class="text-muted">Hóa đơn bạn đang tìm kiếm không tồn tại hoặc đã bị xóa.</p>
                <a href="{{ url_for('booking.list_bookings') }}" class="btn btn-primary mt-3">
                    Quay lại danh sách booking
                </a>
            </div>
        </div>
    {% endif %}

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
